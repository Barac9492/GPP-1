name: GPP Agent - New Version

on:
  schedule:
    # 매일 새벽 2시 (UTC 기준, 한국 시간 오전 11시)
    - cron: '0 2 * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  run-agent:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install agent dependencies
      run: |
        echo "Installing agent-specific dependencies..."
        npm install @anthropic-ai/sdk ai-functions firebase-admin nodemailer puppeteer
        npm install --save-dev @types/nodemailer @types/node tsx typescript
        
    - name: Debug - Check installed packages
      run: |
        echo "Installed packages:"
        npm list --depth=0
        echo "Checking for ai-functions:"
        npm list ai-functions || echo "ai-functions not found"
        
    - name: Install Puppeteer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ca-certificates fonts-liberation libasound2 libatk-bridge2.0-0 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 lsb-release wget xdg-utils
        
    - name: Setup environment
      run: |
        mkdir -p secrets
        mkdir -p logs
        echo '${{ secrets.FIREBASE_ADMIN_SDK_JSON }}' > secrets/globalpp-1-firebase-adminsdk-fbsvc.json
        echo "GPP Agent started at $(date)" > logs/agent.log
        
    - name: Debug - Check file structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        echo "Files in agents directory:"
        ls -la agents/ || echo "agents directory not found"
        echo "Files in modules directory:"
        ls -la modules/ || echo "modules directory not found"
        
    - name: Run GPP Agent with debug
      env:
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      run: |
        echo "🚀 Starting GPP Agent..."
        echo "Environment variables:"
        echo "CLAUDE_API_KEY: ${CLAUDE_API_KEY:0:10}..."
        echo "GMAIL_USER: $GMAIL_USER"
        echo "ADMIN_EMAIL: $ADMIN_EMAIL"
        
        # Try to run the agent
        npx tsx agents/gpp-agent.agent.ts || {
          echo "GPP Agent failed with exit code $?"
          echo "Trying alternative approach..."
          node -e "
            console.log('Testing basic Node.js execution...');
            console.log('Current directory:', process.cwd());
            console.log('Available modules:', Object.keys(require.cache));
          "
        }
        
        echo "GPP Agent execution completed at $(date)" >> logs/agent.log
        echo "✅ GPP Agent workflow completed successfully" 