name: GPP Agent - New Version

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (UTC ê¸°ì¤€, í•œêµ­ ì‹œê°„ ì˜¤ì „ 11ì‹œ)
    - cron: '0 2 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  run-agent:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Install Puppeteer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ca-certificates fonts-liberation libasound2 libatk-bridge2.0-0 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 lsb-release wget xdg-utils
        
    - name: Setup environment
      run: |
        mkdir -p secrets
        mkdir -p logs
        echo '${{ secrets.FIREBASE_ADMIN_SDK_JSON }}' > secrets/globalpp-1-firebase-adminsdk-fbsvc.json
        echo "GPP Agent started at $(date)" > logs/agent.log
        
    - name: Run GPP Agent
      env:
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      run: |
        echo "ðŸš€ Starting GPP Agent..."
        npx tsx agents/gpp-agent.agent.ts || echo "GPP Agent completed with exit code $?"
        echo "GPP Agent execution completed at $(date)" >> logs/agent.log
        echo "âœ… GPP Agent workflow completed successfully" 