name: GPP Agent Daily Run

on:
  schedule:
    # 매일 새벽 2시 (UTC 기준, 한국 시간 오전 11시)
    - cron: '0 2 * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  run-agent:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Install Puppeteer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ca-certificates fonts-liberation libasound2 libatk-bridge2.0-0 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 lsb-release wget xdg-utils
        
    - name: Create secrets directory
      run: mkdir -p secrets
      
    - name: Setup Firebase Admin SDK
      run: |
        echo '${{ secrets.FIREBASE_ADMIN_SDK_JSON }}' > secrets/globalpp-1-firebase-adminsdk-fbsvc.json
        
    - name: Create logs directory
      run: mkdir -p logs
      
    - name: Run GPP Agent
      env:
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      run: |
        npx tsx agents/gpp-agent.agent.ts || echo "GPP Agent failed but continuing..."
        echo "GPP Agent execution completed" > logs/execution.log
        
    - name: Create dummy log files
      run: |
        echo "GPP Agent started at $(date)" > logs/agent.log
        echo "No errors found" > logs/error.log
        
    - name: Upload logs as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gpp-agent-logs
        path: logs/
        retention-days: 30
        
    - name: Upload secrets as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gpp-agent-secrets
        path: secrets/
        retention-days: 30
        
    # Slack 알림은 선택사항이므로 제거
    # 이메일 알림만으로 충분함 